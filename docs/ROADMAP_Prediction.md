# Prediction 改善ロードマップ（完成まで）

目的：
- 安定生活費（ベースライン）を推定し「何もなければ毎月これくらい」を出す
- イベント系出費を検知し「今月は注意」「原因はこれ」を出す
- 最終的に月次アドバイスを自動生成して、アプリ内で意思決定できる状態にする

現状（完了）：
- 月次予測（線形回帰）
- 交際含む/除外の精度比較
- バックテスト
- 誤差が大きい月の表示
- クリックで月内訳（カテゴリ/店）表示
- 学習期間内訳（カテゴリ/店）
- ZスコアTOP3（統計的に異常な月）
- クロス分類（Z × 誤差） ※表示済み

---

## 完成の定義（Definition of Done）
最低限（MVP完成）：
1. ベースライン（イベント除外後の月次/カテゴリ別）を表示
2. イベント候補（月ごとのタグ）を表示
3. クリックで原因（カテゴリ/店/怪しい明細）を表示
4. 月次アドバイスを1〜2文で自動生成して表示

仕上げ（Portfolio完成）：
- 指標定義/限界/次の改善を docs 化
- UI/CSS整備
- テスト（データ少ない/0件/月欠け）と例外対応

---

## Phase1：イベント判定の仕様化 → 月タグ付け（最優先）
狙い：
- 「異常っぽい」を、アプリが“イベント候補”として言い切れる状態にする

やること：
- イベント判定ルール（ルールベース）を決める
  - 高額単発：月内の1明細が閾値超え
  - 月次上振れ：月合計がベースライン + kσ
  - カテゴリ偏り：特定カテゴリがベースライン + kσ
  - 店の異常：店の単価が普段より高い（Phase2で強化）
- 月にタグを付与して表示
  - 例：帰省/医療/大型購入/外食過多/その他

UI：
- Predictionページの上部に「今月の判定」カードを追加
- 既存のクロス分類テーブルにも「分類」列を反映

---

## Phase2：異常度スコア（明細レベル）実装
狙い：
- 「原因明細TOP」を出して、イベントの根拠を説明できる状態にする

データ準備（まずは店ベース）：
- shop別：件数 / 平均 / 中央値 / 最大 / 90%点 or 95%点
（余力があれば category×shop）

異常度スコア案（例）：
- score_shop_amount = (amount - median_shop) / (mad_shop + eps)  ※頑健
- 代替：amount / p95_shop（p95超えたら強めにスコア）
- categoryも同様にスコア化し、合成して「怪しい明細TOP5」を作る

表示：
- 月内訳の下に「怪しい明細TOP（理由付き）」を出す

---

## Phase3：月次アドバイス自動生成（完成感の核）
狙い：
- 数字だけでなく「行動」が出る状態にする

出力例（テンプレでOK）：
- ベースラインとの差分：
  - 「今月は外食がベースより +¥X。週1回減らすと約¥Y改善の余地」
- イベント系：
  - 「今月は帰省（交通）が発生。次回は◯月付近に再発可能性」
  - 「医療は特殊イベント。来月以降はベース回帰見込み」

---

## Phase4：仕上げ（ポートフォリオ品質）
- docs/ に指標定義
  - ベースラインとは
  - Zスコアとは
  - クロス分類の意味（Z×誤差）
  - イベント判定仕様
  - 限界と次の改善案（季節性、カテゴリ別モデル、外れ値処理など）
- UI/CSS整理（見せ場）
- テスト（最低限）
  - データ不足月
  - 0件/欠損
  - exclude切替時の表示崩れ



