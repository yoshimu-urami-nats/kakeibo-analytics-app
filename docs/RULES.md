# Classification Rules (Category / Member)

このドキュメントは `transactions/rules.py` の内容に完全準拠した「分類ルール一覧」。  
（最終更新: 2026-02-13）

---

## 0. 実装場所（Source of Truth）
- `transactions/rules.py`
  - カテゴリ推測: `guess_category(shop) -> Optional[str]`
  - メンバー推測: `guess_member(shop, date, derma_dates=None) -> Optional[str]`

※ seed系（`transactions/seeds/*`）は「初期マスタ投入」用途で、分類ロジックの本体ではない。

---

## 1. 共通仕様（表記ゆれ吸収）

### 1-1. 正規化 `_norm(s)`
店名・キーワードは比較前に正規化される。

- NFKC 正規化（全角/半角などの統一）
- 大文字化（upper）
- 連続空白を1つに圧縮し、前後空白を除去

→ そのため、ルール側のキーワードに多少表記ゆれがあっても部分一致で拾える。

---

## 2. カテゴリ分類（Category）

### 2-1. 返り値
- 一致した場合: `Category.name` と一致するカテゴリ名（文字列）を返す
- 見つからない場合: `None`
- “分類不可能扱い”の場合も `None`

### 2-2. 優先順位（重要）
1) 「分類不可能（Amazon）」チェック  
2) `SHOP_RULES` を上から順に走査し、最初に部分一致したカテゴリを返す  
3) どれも一致しなければ `None`

### 2-3. 分類不可能（カテゴリ付けしない）
- `AMAZON.CO.JP`
- `ＡＭＡＺＯＮ．ＣＯ．ＪＰ`

店名に上記が含まれる場合、カテゴリは `None`。

### 2-4. カテゴリルール一覧（SHOP_RULES）
「店名にキーワードが含まれたらこのカテゴリ」

- 水道:
  - 東京都水道局

- 電気:
  - LOOOP
  - Loooopでんき

- ガス:
  - エルピオ

- インターネット:
  - 東京ベイネットワーク

- 食品・日用品:
  - ライフ
  - まいばすけっと
  - オーケー
  - NEWDAYS
  - ファミリーマート
  - セブン
  - ローソン
  - セリア
  - アトレ亀戸
  - KAMEIDO CLOCK
  - コーナン
  - ココカラファイン
  - マツモトキヨシ
  - スギ薬局
  - カルディ
  - シャトレーゼ
  - おかしのまちおか
  - ミスタードーナツ

- 外食:
  - 雛鮨
  - インド
  - マクドナルド
  - 大戸屋
  - 吉野家
  - 笑縁食堂
  - ママクック
  - パスタママ

- 娯楽:
  - クックパッド
  - DMM
  - GOOGLE PLAY JAPAN
  - ニンテンドー
  - STEAMGAMES

- 医療:
  - 亀戸駅前薬局
  - 錦糸町皮膚科内科クリニック

- 衣服・美容:
  - ユニクロ

- 教養:
  - APPLE COM BILL

- その他:
  - ソフトバンクM

---

## 3. メンバー分類（Member）

### 3-1. 返り値
- 一致した場合: `"な"` / `"ゆ"` / `"共有"` のいずれかを返す
- 分類しない場合: `None`

### 3-2. 優先順位（超重要）
1) MEMBER_UNCLASSIFIABLE（分類しない）に該当 → `None`  
2) 皮膚科ルール（薬局だけ特例）  
3) 土日/平日で分岐する店（週末共有・平日ゆ）  
4) 固定ルール（MEMBER_RULES）  
5) どれも一致しなければ `None`

### 3-3. 分類しない（Noneで返す）
- ＡＭＡＺＯＮ．ＣＯ．ＪＰ
- ニンテンドー
- STEAMGAMES
- ユニクロ

※カテゴリ側ではニンテンドー/STEAMGAMES/ユニクロが分類対象になっているが、  
メンバー側では「分類しない」扱いになっている点に注意。

### 3-4. 皮膚科関連の特例（薬局だけ判定が分岐）
- 皮膚科クリニック: `錦糸町皮膚科内科クリニック`
- 皮膚科薬局: `亀戸駅前薬局`

薬局（亀戸駅前薬局）の場合のみ特例：
- `derma_dates` に当日が含まれる → `"ゆ"`
- それ以外 → `"な"`

※ `derma_dates` は「同日に皮膚科クリニックがある日付の集合」を views 側で作って渡す想定。

### 3-5. 土日/平日で分岐する店
対象キーワード（部分一致）：
- ＮｅｗＤａｙｓ
- ファミリーマート
- セブン
- ローソン
- 大戸屋
- 吉野家

判定：
- 土日（weekday >= 5） → `"共有"`
- 平日 → `"ゆ"`

### 3-6. 固定ルール（MEMBER_RULES）
「店名にキーワードが含まれたらこのメンバー」

- な:
  - ＧＯＯＧＬＥ　ＰＬＡＹ　ＪＡＰＡＮ
  - ＡＰＰＬＥ　ＣＯＭ　ＢＩＬＬ

- ゆ:
  - 笑縁食堂
  - ママクック
  - パスタママ
  - 錦糸町皮膚科内科クリニック
  - ソフトバンクＭ

- 共有:
  - 東京都水道局
  - Ｌｏｏｏｐでんき
  - エルピオ
  - 東京ベイネットワーク
  - ライフ
  - まいばすけっと
  - オーケー
  - セリア
  - アトレ亀戸
  - ＫＡＭＥＩＤＯ  ＣＬＯＣＫ
  - コーナン
  - ココカラファイン
  - マツモトキヨシ
  - スギ薬局
  - カルディ
  - シャトレーゼ
  - おかしのまちおか
  - ミスタードーナツ
  - 雛鮨
  - インド
  - マクドナルド
  - クックパッド
  - ＤＭＭ

---

## 4. 注意点（仕様メモ）

### 4-1. 「カテゴリは付くけどメンバーは付かない」ケースがある
例:
- ユニクロ → カテゴリ: 衣服・美容 / メンバー: None
- ニンテンドー → カテゴリ: 娯楽 / メンバー: None
- STEAMGAMES → カテゴリ: 娯楽 / メンバー: None

### 4-2. ルールの優先順位が結果を左右する
- メンバー分類は「分類しない」判定が最優先
- 薬局（亀戸駅前薬局）は “皮膚科が同日にあるか” で分岐する

---

## 5. 改善案（将来）
- ルールのDB化（テーブル化）
- 優先順位を明示したルールエンジン化
- “カテゴリだけ/メンバーだけ” の不整合チェック（Lint）
