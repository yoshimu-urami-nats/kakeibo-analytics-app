{% extends "account/base.html" %}
{% block title %}Table{% endblock %}

{% block content %}
<h1>Table</h1>

<div class="card table-head">
  <div class="muted">
    対象ファイル：
    {% if latest_source %}<b>{{ latest_source }}</b>{% else %}（未取り込み）{% endif %}
    ／ 編集モード：{% if edit_mode %}<b>ON</b>{% else %}OFF{% endif %}
    {% if edit_mode %} ／ 表示：{% if show_all %}<b>全件</b>{% else %}<b>未割当のみ</b>{% endif %}{% endif %}
  </div>

  <form method="get" class="table-toolbar">
    <input class="input"
           type="text"
           name="q"
           placeholder="検索（店名 / メモ / 金額 / カテゴリ / メンバー / 日付 など）"
           value="{{ request.GET.q|default:'' }}">

    <div class="toolbar-actions">
      {% if edit_mode %}
        <a class="btn" href="?">編集OFF</a>
      {% else %}
        <a class="btn" href="?edit=1">編集ON</a>
      {% endif %}

      {% if edit_mode %}
        {% if show_all %}
          <a class="btn" href="?edit=1">未割当のみ</a>
        {% else %}
          <a class="btn" href="?edit=1&all=1">全件表示</a>
        {% endif %}
      {% endif %}
    </div>
  </form>
</div>

{% if edit_mode %}
<div class="card bulk-card">
  <h2 class="h2">一括操作</h2>

  <form method="post" id="bulkForm">
    {% csrf_token %}
    <input type="hidden" name="selected_ids" id="selectedIds" value="">
    <div class="bulk-grid">
      <div class="bulk-item">
        <div class="muted">カテゴリ一括</div>
        <div class="bulk-row">
          <select name="category_id" class="select">
            <option value="">カテゴリを選択</option>
            {% for c in categories %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
          <button class="btn" type="submit" name="bulk_action" value="category">適用</button>
        </div>
      </div>

      <div class="bulk-item">
        <div class="muted">メンバー一括</div>
        <div class="bulk-row">
          <select name="member_id" class="select">
            <option value="">メンバーを選択</option>
            {% for m in members %}
              <option value="{{ m.id }}">{{ m.name }}</option>
            {% endfor %}
          </select>
          <button class="btn" type="submit" name="bulk_action" value="member">適用</button>
        </div>
      </div>

      <div class="bulk-item">
        <div class="muted">確定（カテゴリ&メンバー埋まってる行だけ）</div>
        <button class="btn btn-primary" type="submit" name="bulk_action" value="confirm">確定する</button>
      </div>
    </div>
  </form>
</div>
{% endif %}

<div class="card table-card">
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          {% if edit_mode %}<th class="col-check"><input type="checkbox" id="checkAll"></th>{% endif %}
          <th>ID</th>
          <th>日付</th>
          <th>店名</th>
          <th>金額</th>
          <th>カテゴリ</th>
          <th>メンバー</th>
          <th>確定</th>
        </tr>
      </thead>
      <tbody>
        {% for t in transactions %}
        <tr>
          {% if edit_mode %}
            <td class="col-check"><input type="checkbox" class="rowCheck" value="{{ t.id }}"></td>
          {% endif %}
          <td>{{ t.id }}</td>
          <td>{{ t.date }}</td>
          <td>{{ t.shop }}</td>
          <td>{{ t.amount }}</td>
          <td>{% if t.category %}{{ t.category.name }}{% else %}<span class="pill warn">未</span>{% endif %}</td>
          <td>{% if t.member %}{{ t.member.name }}{% else %}<span class="pill warn">未</span>{% endif %}</td>
          <td>{% if t.is_closed %}<span class="pill ok">済</span>{% else %}<span class="pill">未</span>{% endif %}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8" class="muted">データがありません</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  (function(){
    const checkAll = document.getElementById("checkAll");
    const checks = Array.from(document.querySelectorAll(".rowCheck"));
    const selectedIds = document.getElementById("selectedIds");
    const bulkForm = document.getElementById("bulkForm");

    if(!bulkForm) return;

    function sync(){
      const ids = checks.filter(c => c.checked).map(c => c.value);
      selectedIds.value = ids.join(",");
    }

    if(checkAll){
      checkAll.addEventListener("change", () => {
        checks.forEach(c => c.checked = checkAll.checked);
        sync();
      });
    }

    checks.forEach(c => c.addEventListener("change", sync));

    bulkForm.addEventListener("submit", (e) => {
      sync();
      if(!selectedIds.value){
        e.preventDefault();
        alert("チェックされた行がないよ");
      }
    });
  })();
</script>

<script>
  (function(){
    const form = document.querySelector("form.table-toolbar");
    const input = form?.querySelector('input[name="q"]');
    if(!form || !input) return;

    // ページ表示時：qがあれば検索窓を自動フォーカスして末尾にカーソル
    // ※ 「検索中に結果が更新されてフォーカスが飛ぶ」を見た目上ほぼ解消できる
    const params = new URLSearchParams(window.location.search);
    const hasQ = (params.get("q") || "").trim().length > 0;

    if(hasQ){
      // 画面描画後にフォーカス（描画タイミング対策）
      requestAnimationFrame(() => {
        input.focus({ preventScroll: true });
        const v = input.value || "";
        input.setSelectionRange(v.length, v.length);
      });
    }

    // 既存のクエリを保持したまま q だけ更新する
    function buildUrl(nextQ){
      const url = new URL(window.location.href);
      if(nextQ){
        url.searchParams.set("q", nextQ);
      }else{
        url.searchParams.delete("q");
      }
      return url.toString();
    }

    // 入力中に連打で遷移しないように debounce
    let t = null;
    input.addEventListener("input", () => {
      window.clearTimeout(t);
      t = window.setTimeout(() => {
        window.location.href = buildUrl(input.value.trim());
      }, 350);
    });

    // Enterで即実行（好み）
    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        window.clearTimeout(t);
        window.location.href = buildUrl(input.value.trim());
      }
    });
  })();
</script>


{% endblock %}
