{% extends "account/base.html" %}

{% block title %}明細一覧{% endblock %}

{% block content %}

<p>
    <a href="{% url 'home' %}">← トップに戻る</a>
</p>

<hr>

<h2>CSV取り込み</h2>
{% if messages %}
  <ul>
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  {{ upload_form.csv_file }}
  <button type="submit">CSVを取り込む</button>
</form>

{% if edit_mode and transactions|length == 0 %}
  <p>未割当てはありません（最新ファイル分）</p>
{% endif %}

<hr>

{% if summary %}
  <hr>
  <h3>最新データ（確定済みのみ）サマリ</h3>

  <table border="1" cellpadding="6" style="border-collapse: collapse; margin-top: 8px;">
    <thead>
      <tr>
        <th></th>
        <th>合計</th>
        <th>一人当たり</th>
        <th>住信SBI振込</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>な</td>
        <td>¥{{ summary.n_total }}</td>
        <td>¥0</td>
        <td>¥{{ summary.transfer_n }}</td>
      </tr>
      <tr>
        <td>ゆ</td>
        <td>¥{{ summary.y_total }}</td>
        <td>¥0</td>
        <td>¥{{ summary.transfer_y }}</td>
      </tr>
      <tr>
        <td>共有</td>
        <td>¥{{ summary.shared_total }}</td>
        <td>¥{{ summary.shared_per_person }}</td>
        <td>-</td>
      </tr>
      <tr>
        <td>家賃</td>
        <td>¥{{ summary.rent }}</td>
        <td>¥{{ summary.rent_per_person }}</td>
        <td>-</td>
      </tr>
      <tr>
        <td>家賃更新料</td>
        <td>¥{{ summary.rent_renewal }}</td>
        <td>¥{{ summary.rent_renewal_per_person }}</td>
        <td>-</td>
      </tr>
      <tr>
        <td>WRX</td>
        <td>¥{{ summary.wrx }}</td>
        <td>¥{{ summary.wrx_per_person }}</td>
        <td>-</td>
      </tr>
    </tbody>
  </table>

  <p style="font-size: 12px; opacity: 0.8; margin-top: 6px;">
    ※家賃更新料：2026年6月まで適用。7月からは無し予定。更新料引き落とし月確定＆次回更新月確定後にルール追加予定。
  </p>
{% endif %}


<hr>

<div class="transaction-search">
  <label for="transactionSearchInput">明細を検索：</label>
  <input
    type="text"
    id="transactionSearchInput"
    placeholder="カテゴリ / メモ / 店名 / 金額 などで絞り込み"
  />
</div>

<div style="display:flex; gap:12px; align-items:center; margin: 12px 0;">
  {% if edit_mode %}
    <a href="{% url 'transactions:list' %}">編集モード: ON（クリックでOFF）</a>
  {% else %}
    <a href="{% url 'transactions:list' %}?edit=1">編集モード: OFF（クリックでON）</a>
  {% endif %}

  {% if edit_mode %}
    <span style="margin-left:12px;"></span>
    {% if show_all %}
      <a href="{% url 'transactions:list' %}?edit=1">表示: 全行（クリックで未割当てだけ）</a>
    {% else %}
      <a href="{% url 'transactions:list' %}?edit=1&all=1">表示: 未割当てだけ（クリックで全行）</a>
    {% endif %}
  {% endif %}

  {% if latest_source %}
    <span>対象ファイル: {{ latest_source }}</span>
  {% endif %}
</div>

{% if edit_mode %}
<form method="post" id="bulkForm" style="margin: 10px 0;">
  {% csrf_token %}

  <!-- 選択された行IDを詰める場所（JSで入れる） -->
  <input type="hidden" name="selected_ids" id="selectedIds">

  <label>カテゴリ：</label>
  <select name="category_id" id="bulkCategory">
    <option value="">-- 選択 --</option>
    {% for c in categories %}
      <option value="{{ c.id }}">{{ c.name }}</option>
    {% endfor %}
  </select>

  <button type="submit" name="bulk_action" value="category">
    カテゴリ一括適用
  </button>

  <span style="margin-left:12px;"></span>

  <label>メンバー：</label>
  <select name="member_id" id="bulkMember">
    <option value="">-- 選択 --</option>
    {% for m in members %}
      <option value="{{ m.id }}">{{ m.name }}</option>
    {% endfor %}
  </select>

  <button type="submit" name="bulk_action" value="member">
    メンバー一括適用
  </button>

  <button type="submit" name="bulk_action" value="confirm" id="confirmBtn">
    確定済みにする
  </button>

</form>
{% endif %}



<h2>明細一覧</h2>
<table id="transactionTable" class="transaction-table">
  <thead>
    <tr>
      {% if edit_mode %}
        <th><input type="checkbox" id="checkAll"></th>
      {% endif %}

      <th>ID</th>
      <th>日付</th>
      <th>店名・サービス名</th>
      <th>金額</th>

      <th>メンバー</th>
      <th>メンバーID</th>

      <th>カテゴリ</th>
      <th>カテゴリID</th>

      <th>メモ</th>
      <th>ファイル名</th>
      <th>確定済みか</th>
    </tr>
  </thead>

  <tbody>
    {% for t in transactions %}
      <tr>
        {% if edit_mode %}
          <td>
            <input type="checkbox"
                  class="row-check"
                  value="{{ t.id }}"
                  data-has-category="{% if t.category_id %}1{% else %}0{% endif %}"
                  data-has-member="{% if t.member_id %}1{% else %}0{% endif %}">

          </td>
        {% endif %}

        <td>{{ t.id }}</td>
        <td>{{ t.date_label }}</td>
        <td>{{ t.shop }}</td>
        <td>{{ t.amount }}</td>

        <td>{% if t.member %}{{ t.member.name }}{% else %}-{% endif %}</td>
        <td>{{ t.member_id|default:"-" }}</td>

        <td>{% if t.category %}{{ t.category.name }}{% else %}-{% endif %}</td>
        <td>{{ t.category_id|default:"-" }}</td>

        <td>{{ t.memo }}</td>
        <td>{{ t.source_file }}</td>
        <td>{{ t.is_closed }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="{% if edit_mode %}12{% else %}11{% endif %}">
          まだ明細は登録されていません。
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ===== 全選択（ヘッダ） =====
  const checkAll = document.getElementById("checkAll");
  const rowChecks = Array.from(document.querySelectorAll(".row-check"));

  if (checkAll) {
    // ヘッダの□を押したら、全部ON/OFF
    checkAll.addEventListener("change", function () {
      rowChecks.forEach(cb => cb.checked = checkAll.checked);
    });

    // 行の□を1個でも外したらヘッダOFF、全部ONならヘッダON
    rowChecks.forEach(cb => {
      cb.addEventListener("change", function () {
        const allChecked = rowChecks.length > 0 && rowChecks.every(x => x.checked);
        const anyChecked = rowChecks.some(x => x.checked);

        checkAll.checked = allChecked;
        checkAll.indeterminate = !allChecked && anyChecked; // 途中状態（Excelっぽい）
      });
    });
  }

  const input = document.getElementById("transactionSearchInput");
  const table = document.getElementById("transactionTable");
  if (!input || !table) return;

  //  データ行だけ（thead除外）
  const dataRows = Array.from(table.querySelectorAll("tbody tr"));

  input.addEventListener("input", function () {
    const keyword = input.value.trim().toLowerCase();

    dataRows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(keyword) ? "" : "none";
    });
  });

  const bulkForm = document.getElementById("bulkForm");
  if (bulkForm) {
    bulkForm.addEventListener("submit", function (e) {
      const checked = Array.from(document.querySelectorAll(".row-check:checked"));
      if (checked.length === 0) {
        e.preventDefault();
        alert("一括適用したい行をチェックしてね！");
        return;
      }

      // 例: ["92","87","80"] を "92,87,80" にする
      const ids = checked.map(cb => cb.value).join(",");
      document.getElementById("selectedIds").value = ids;

      // 押したボタンがカテゴリかメンバーかで、未選択を弾く
      const submitter = e.submitter; // 押されたボタン
      if (submitter && submitter.value === "category") {
        const cat = document.getElementById("bulkCategory").value;
        if (!cat) { e.preventDefault(); alert("カテゴリを選んでね！"); }
      }
      if (submitter && submitter.value === "member") {
        const mem = document.getElementById("bulkMember").value;
        if (!mem) { e.preventDefault(); alert("メンバーを選んでね！"); }
      }

      // ★ confirm のとき：チェックした行がカテゴリ/メンバー両方埋まってるか確認
      if (submitter && submitter.value === "confirm") {
        const invalid = checked.some(cb =>
          cb.dataset.hasCategory !== "1" || cb.dataset.hasMember !== "1"
        );
        if (invalid) {
          e.preventDefault();
          alert("カテゴリ/メンバー未割当の行が含まれてるから確定できないよ");
          return;
        }
      }
    });
  }

});
</script>

{% endblock %}
