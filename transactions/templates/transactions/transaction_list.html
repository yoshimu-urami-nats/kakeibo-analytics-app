{% extends "account/base.html" %}

{% block title %}明細一覧{% endblock %}

{% block content %}

<p>
    <a href="{% url 'home' %}">← トップに戻る</a>
</p>

<hr>

<h2>CSV取り込み</h2>
{% if messages %}
  <ul>
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  {{ upload_form.csv_file }}
  <button type="submit">CSVを取り込む</button>
</form>

{% if edit_mode and transactions|length == 0 %}
  <p>未割当てはありません（最新ファイル分）</p>
{% endif %}

<hr>

<div class="transaction-search">
  <label for="transactionSearchInput">明細を検索：</label>
  <input
    type="text"
    id="transactionSearchInput"
    placeholder="カテゴリ / メモ / 店名 / 金額 などで絞り込み"
  />
</div>

<div style="display:flex; gap:12px; align-items:center; margin: 12px 0;">
  {% if edit_mode %}
    <a href="{% url 'transactions:list' %}">編集モード: ON（クリックでOFF）</a>
  {% else %}
    <a href="{% url 'transactions:list' %}?edit=1">編集モード: OFF（クリックでON）</a>
  {% endif %}

  {% if latest_source %}
    <span>対象ファイル: {{ latest_source }}</span>
  {% endif %}
</div>


<h2>明細一覧</h2>
<table id="transactionTable" class="transaction-table">
  <thead>
    <tr>
      {% if edit_mode %}
        <th><input type="checkbox" id="checkAll"></th>
      {% endif %}

      <th>ID</th>
      <th>日付</th>
      <th>店名・サービス名</th>
      <th>金額</th>

      <th>メンバー</th>
      <th>メンバーID</th>

      <th>カテゴリ</th>
      <th>カテゴリID</th>

      <th>メモ</th>
      <th>ファイル名</th>
      <th>確定済みか</th>
    </tr>
  </thead>

  <tbody>
    {% for t in transactions %}
      <tr>
        {% if edit_mode %}
          <td>
            <input type="checkbox" class="row-check" name="selected_ids" value="{{ t.id }}">
          </td>
        {% endif %}

        <td>{{ t.id }}</td>
        <td>{{ t.date_label }}</td>
        <td>{{ t.shop }}</td>
        <td>{{ t.amount }}</td>

        <td>{% if t.member %}{{ t.member.name }}{% else %}-{% endif %}</td>
        <td>{{ t.member_id|default:"-" }}</td>

        <td>{% if t.category %}{{ t.category.name }}{% else %}-{% endif %}</td>
        <td>{{ t.category_id|default:"-" }}</td>

        <td>{{ t.memo }}</td>
        <td>{{ t.source_file }}</td>
        <td>{{ t.is_closed }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="{% if edit_mode %}12{% else %}11{% endif %}">
          まだ明細は登録されていません。
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // ===== 全選択（ヘッダ） =====
  const checkAll = document.getElementById("checkAll");
  const rowChecks = Array.from(document.querySelectorAll(".row-check"));

  if (checkAll) {
    // ヘッダの□を押したら、全部ON/OFF
    checkAll.addEventListener("change", function () {
      rowChecks.forEach(cb => cb.checked = checkAll.checked);
    });

    // 行の□を1個でも外したらヘッダOFF、全部ONならヘッダON
    rowChecks.forEach(cb => {
      cb.addEventListener("change", function () {
        const allChecked = rowChecks.length > 0 && rowChecks.every(x => x.checked);
        const anyChecked = rowChecks.some(x => x.checked);

        checkAll.checked = allChecked;
        checkAll.indeterminate = !allChecked && anyChecked; // 途中状態（Excelっぽい）
      });
    });
  }

  const input = document.getElementById("transactionSearchInput");
  const table = document.getElementById("transactionTable");
  if (!input || !table) return;

  //  データ行だけ（thead除外）
  const dataRows = Array.from(table.querySelectorAll("tbody tr"));

  input.addEventListener("input", function () {
    const keyword = input.value.trim().toLowerCase();

    dataRows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(keyword) ? "" : "none";
    });
  });
});
</script>

{% endblock %}
