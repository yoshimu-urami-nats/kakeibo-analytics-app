{% extends "account/base.html" %}

{% block title %}明細一覧{% endblock %}

{% block content %}

<p>
    <a href="{% url 'home' %}">← トップに戻る</a>
</p>

<hr>

<h2>CSV取り込み</h2>
{% if messages %}
  <ul>
    {% for message in messages %}
      <li>{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}

<form method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  {{ upload_form.csv_file }}
  <button type="submit">CSVを取り込む</button>
</form>

<hr>

<div class="transaction-search">
  <label for="transactionSearchInput">明細を検索：</label>
  <input
    type="text"
    id="transactionSearchInput"
    placeholder="カテゴリ / メモ / 店名 / 金額 などで絞り込み"
  />
</div>

<h2>明細一覧</h2>
<table>
  <thead>
    <tr>
      <th>ID</th>
      <th>日付</th>
      <th>店名・サービス名</th>
      <th>金額</th>

      <th>メンバー</th>
      <th>メンバーID</th>

      <th>カテゴリ</th>
      <th>カテゴリID</th>

      <th>メモ</th>
      <th>インポート月</th>
      <th>確定済みか</th>
    </tr>
  </thead>

  <tbody>
    {% for t in transactions %}
      <tr>
        <td>{{ t.id }}</td>
        <td>{{ t.date }}</td>
        <td>{{ t.shop }}</td>
        <td>{{ t.amount }}</td>

        <td>{% if t.member %}{{ t.member.name }}{% else %}-{% endif %}</td>
        <td>{{ t.member_id|default:"-" }}</td>

        <td>{% if t.category %}{{ t.category.name }}{% else %}-{% endif %}</td>
        <td>{{ t.category_id|default:"-" }}</td>

        <td>{{ t.memo }}</td>
        <td>{{ t.import_month }}</td>
        <td>{{ t.is_closed }}</td>
      </tr>
    {% empty %}
      <tr><td colspan="11">まだ明細は登録されていません。</td></tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("transactionSearchInput");
    const table = document.getElementById("transactionTable");
    if (!input || !table) return;

    // すべての行を取得
    const allRows = Array.from(table.querySelectorAll("tr"));

    // 最初の行（ヘッダー）は除外、それ以降がデータ
    const dataRows = allRows.slice(1);

    input.addEventListener("input", function () {
        const keyword = input.value.trim().toLowerCase();

        dataRows.forEach((row) => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(keyword) ? "" : "none";
        });
    });
});
</script>

{% endblock %}
