{% extends "account/base.html" %}
{% block title %}Table{% endblock %}

{% block content %}
<div class="table-page">
  <h1>Table</h1>

  <!-- ▼▼ summaryここから ▼▼ -->
  {% load humanize %}
  <details class="acc" open>
    <summary class="acc-title">
      <span>Summary</span>
      <span class="muted">（クリックで開閉）</span>
    </summary>

    <div class="card summary-card">
      <div class="summary-head">
        <h2 class="h2">Summary</h2>
        <div class="muted">
          対象ファイル：
          {% if latest_source %}<b>{{ latest_source }}</b>{% else %}（未取り込み）{% endif %}
          ／ 確定済みのみ
        </div>
      </div>

      <!-- サマリテーブル -->
      <table class="summary-table">
        <thead>
          <tr>
            <th></th>
            <th>合計</th>
            <th>一人当たり</th>
            <th>住信SBI振込</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <th class="rowhead">な</th>
            <td class="num">¥{{ summary.n_total|intcomma }}</td>
            <td class="num muted">¥0</td>
            <td class="num">¥{{ summary.transfer_n|intcomma }}</td>
          </tr>

          <tr>
            <th class="rowhead">ゆ</th>
            <td class="num">¥{{ summary.y_total|intcomma }}</td>
            <td class="num muted">¥0</td>
            <td class="num">¥{{ summary.transfer_y|intcomma }}</td>
          </tr>

          <tr>
            <th class="rowhead">共有</th>
            <td class="num">¥{{ summary.shared_total|intcomma }}</td>
            <td class="num">¥{{ summary.shared_per_person|intcomma }}</td>
            <td class="num muted">—</td>
          </tr>

          <tr class="sep">
            <th colspan="4">固定費</th>
          </tr>

          <tr>
            <th class="rowhead">家賃</th>
            <td class="num">¥{{ summary.rent|intcomma }}</td>
            <td class="num">¥{{ summary.rent_per_person|intcomma }}</td>
            <td class="num muted">—</td>
          </tr>

          <tr>
            <th class="rowhead">更新料</th>
            <td class="num">¥{{ summary.rent_renewal|intcomma }}</td>
            <td class="num">¥{{ summary.rent_renewal_per_person|intcomma }}</td>
            <td class="num muted">—</td>
          </tr>

          <tr>
            <th class="rowhead">WRX</th>
            <td class="num">¥{{ summary.wrx|intcomma }}</td>
            <td class="num">¥{{ summary.wrx_per_person|intcomma }}</td>
            <td class="num muted">—</td>
          </tr>

          <tr class="total">
            <th class="rowhead">固定費 合計</th>
            <td class="num">¥{{ summary.fixed_total|intcomma }}</td>
            <td class="num">¥{{ summary.per_person_total|intcomma }}</td>
            <td class="num muted">—</td>
          </tr>
        </tbody>
      </table>

    </div>
  </details>
  <!-- ▲▲ summaryここまで ▲▲ -->

  <div class="card table-head">
    <div class="muted">
      対象ファイル：
      {% if latest_source %}<b>{{ latest_source }}</b>{% else %}（未取り込み）{% endif %}
      ／ 編集モード：{% if edit_mode %}<b>ON</b>{% else %}OFF{% endif %}
      {% if edit_mode %} ／ 表示：{% if show_all %}<b>全件</b>{% else %}<b>未割当のみ</b>{% endif %}{% endif %}
    </div>

    <form method="get" class="table-toolbar">
      <input class="input"
            type="text"
            name="q"
            placeholder="検索（店名 / メモ / 金額 / カテゴリ / メンバー / 日付 など）"
            value="{{ request.GET.q|default:'' }}">

      <div class="toolbar-actions">
        {% if edit_mode %}
          <a class="btn" href="?">編集OFF</a>
        {% else %}
          <a class="btn" href="?edit=1">編集ON</a>
        {% endif %}

        {% if edit_mode %}
          {% if show_all %}
            <a class="btn" href="?edit=1">未割当のみ</a>
          {% else %}
            <a class="btn" href="?edit=1&all=1">全件表示</a>
          {% endif %}
        {% endif %}
      </div>
    </form>
  </div>


  {% if edit_mode %}
  <div class="card bulk-card">
    <h2 class="h2">一括操作</h2>

    <form method="post" id="bulkForm">
      {% csrf_token %}
      <input type="hidden" name="selected_ids" id="selectedIds" value="">
      <div class="bulk-grid">
        <div class="bulk-item">
          <div class="muted">カテゴリ一括</div>
          <div class="bulk-row">
            <select name="category_id" class="select">
              <option value="">カテゴリを選択</option>
              {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
            <button class="btn" type="submit" name="bulk_action" value="category">適用</button>
          </div>
        </div>

        <div class="bulk-item">
          <div class="muted">メンバー一括</div>
          <div class="bulk-row">
            <select name="member_id" class="select">
              <option value="">メンバーを選択</option>
              {% for m in members %}
                <option value="{{ m.id }}">{{ m.name }}</option>
              {% endfor %}
            </select>
            <button class="btn" type="submit" name="bulk_action" value="member">適用</button>
          </div>
        </div>

        <div class="bulk-item">
          <div class="muted">確定（カテゴリ&メンバー埋まってる行だけ）</div>
          <button class="btn btn-primary" type="submit" name="bulk_action" value="confirm">確定する</button>
        </div>
      </div>
    </form>
  </div>
  {% endif %}

  <div class="card table-card">
    <div class="table-wrap">
      <table class="table {% if edit_mode %}is-edit{% else %}is-view{% endif %}">
        <thead>
          <tr>
            {% if edit_mode %}<th class="col-check"><input type="checkbox" id="checkAll"></th>{% endif %}
            <th>ID</th>
            <th>日付</th>
            <th>店名</th>
            <th>メモ</th>
            <th>金額</th>
            <th>カテゴリ</th>
            <th>メンバー</th>
            <th>確定</th>
          </tr>
        </thead>

        <tbody id="txTbody">
          {% include "transactions/_transaction_rows.html" %}
        </tbody>

      </table>
    </div>
  </div>
</div>

<script>
  (function(){
    const checkAll = document.getElementById("checkAll");
    const checks = Array.from(document.querySelectorAll(".rowCheck"));
    const selectedIds = document.getElementById("selectedIds");
    const bulkForm = document.getElementById("bulkForm");

    if(!bulkForm) return;

    function sync(){
      const ids = checks.filter(c => c.checked).map(c => c.value);
      selectedIds.value = ids.join(",");
    }

    if(checkAll){
      checkAll.addEventListener("change", () => {
        checks.forEach(c => c.checked = checkAll.checked);
        sync();
      });
    }

    checks.forEach(c => c.addEventListener("change", sync));

    bulkForm.addEventListener("submit", (e) => {
      sync();
      if(!selectedIds.value){
        e.preventDefault();
        alert("チェックされた行がないよ");
      }
    });
  })();
</script>

<script>
  (function(){
    const form = document.querySelector("form.table-toolbar");
    const input = form?.querySelector('input[name="q"]');
    const tbody = document.getElementById("txTbody");
    if(!form || !input || !tbody) return;

    function buildRowsUrl(nextQ){
      const url = new URL(window.location.href);
      url.pathname = url.pathname.replace(/\/?$/, "/") + "rows/"; // /transactions/rows/
      if(nextQ) url.searchParams.set("q", nextQ);
      else url.searchParams.delete("q");
      return url.toString();
    }

    function updateAddressBar(nextQ){
      const url = new URL(window.location.href);
      if(nextQ) url.searchParams.set("q", nextQ);
      else url.searchParams.delete("q");
      history.replaceState(null, "", url.toString());
    }

    let t = null;
    let lastToken = 0;

    async function fetchRows(q){
      const token = ++lastToken;
      const res = await fetch(buildRowsUrl(q), { headers: { "X-Requested-With": "fetch" }});
      if(!res.ok) return;
      const html = await res.text();
      if(token !== lastToken) return; // 古いレスポンスは捨てる
      tbody.innerHTML = html;
      updateAddressBar(q);
      // フォーカス維持（遷移しないので基本要らないけど保険）
      input.focus({ preventScroll: true });
      const v = input.value || "";
      input.setSelectionRange(v.length, v.length);
    }

    input.addEventListener("input", () => {
      window.clearTimeout(t);
      t = window.setTimeout(() => {
        fetchRows(input.value.trim());
      }, 250); // ちょい短めでOK
    });

    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        window.clearTimeout(t);
        fetchRows(input.value.trim());
      }
    });
  })();
</script>

{% endblock %}
