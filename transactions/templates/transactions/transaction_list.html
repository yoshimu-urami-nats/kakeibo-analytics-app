{% extends "account/base.html" %}
{% block title %}Table{% endblock %}

{% block content %}
<div class="table-page">
  <h1>Table</h1>

  <!-- ▼▼ summaryここから ▼▼ -->
  {% load humanize %}

  <div class="card summary-shell">
    <details class="acc">
      <summary class="acc-title">
        <span class="acc-label">Summary</span>
      </summary>

      <!-- ★内側だけ幅を制限する -->
      <div class="summary-content">
        <div class="summary-inner">
          <div class="summary-head">
            <div class="muted">
              対象ファイル：
              {% if latest_source %}<b>{{ latest_source }}</b>{% else %}（未取り込み）{% endif %}
              ／ 確定済みのみ
            </div>
          </div>

          <!-- サマリテーブル -->
          <table class="summary-table">
            <thead>
              <tr>
                <th></th>
                <th>合計</th>
                <th>一人当たり</th>
                <th>住信SBI振込</th>
              </tr>
            </thead>

            <tbody>
              <tr>
                <th class="rowhead">な</th>
                <td class="num">¥{{ summary.n_total|intcomma }}</td>
                <td class="num muted">—</td>
                <td class="num">¥{{ summary.transfer_n|intcomma }}</td>
              </tr>

              <tr>
                <th class="rowhead">ゆ</th>
                <td class="num">¥{{ summary.y_total|intcomma }}</td>
                <td class="num muted">—</td>
                <td class="num">¥{{ summary.transfer_y|intcomma }}</td>
              </tr>

              <tr>
                <th class="rowhead">共有</th>
                <td class="num">¥{{ summary.shared_total|intcomma }}</td>
                <td class="num">¥{{ summary.shared_per_person|intcomma }}</td>
                <td class="num muted">—</td>
              </tr>

              <tr>
                <th class="rowhead">家賃</th>
                <td class="num">¥{{ summary.rent|intcomma }}</td>
                <td class="num">¥{{ summary.rent_per_person|intcomma }}</td>
                <td class="num muted">—</td>
              </tr>

              <tr>
                <th class="rowhead">更新料</th>
                <td class="num">¥{{ summary.rent_renewal|intcomma }}</td>
                <td class="num">¥{{ summary.rent_renewal_per_person|intcomma }}</td>
                <td class="num muted">—</td>
              </tr>

              <tr>
                <th class="rowhead">WRX</th>
                <td class="num">¥{{ summary.wrx|intcomma }}</td>
                <td class="num">¥{{ summary.wrx_per_person|intcomma }}</td>
                <td class="num muted">—</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </details>
  </div>
  <!-- ▲▲ summaryここまで ▲▲ -->

  <div class="card table-head">
    <div class="muted">
      対象ファイル：
      {% if latest_source %}<b>{{ latest_source }}</b>{% else %}（未取り込み）{% endif %}
      ／ 編集モード：{% if edit_mode %}<b>ON</b>{% else %}OFF{% endif %}
      {% if edit_mode %} ／ 表示：{% if show_all %}<b>全件</b>{% else %}<b>未割当のみ</b>{% endif %}{% endif %}
    </div>

    <form method="get" class="table-toolbar">
      <input class="input"
            type="text"
            name="q"
            placeholder="検索（店名 / メモ / 金額 / カテゴリ / メンバー / 日付 など）"
            value="{{ request.GET.q|default:'' }}">

      <div class="toolbar-actions">

        <!-- ① 編集モード：トグル（見た目はトグル、挙動はリンク） -->
        <div class="edit-toggle">
          <div class="edit-toggle-label">編集モード</div>

          {% if edit_mode %}
            <a class="toggle on"
              href="?{% if request.GET.q %}q={{ request.GET.q|urlencode }}{% endif %}"
              aria-label="編集モードをOFFにする">
              <span class="toggle-knob" aria-hidden="true"></span>
            </a>
          {% else %}
            <a class="toggle off"
              href="?edit=1{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
              aria-label="編集モードをONにする">
              <span class="toggle-knob" aria-hidden="true"></span>
            </a>
          {% endif %}
        </div>

        <!-- ② 表示切替：ON=全件 / OFF=未割当のみ -->
        <div class="edit-toggle view-toggle">
          <div class="edit-toggle-label">表示</div>

          {% if edit_mode %}
            {% if show_all %}
              <!-- ON（全件）→ OFF（未割当のみ）へ -->
              <a class="toggle on js-toggle-anim"
                href="?edit=1{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                aria-label="未割当のみを表示">
                <span class="toggle-knob" aria-hidden="true"></span>
              </a>
            {% else %}
              <!-- OFF（未割当のみ）→ ON（全件）へ -->
              <a class="toggle off js-toggle-anim"
                href="?edit=1&all=1{% if request.GET.q %}&q={{ request.GET.q|urlencode }}{% endif %}"
                aria-label="全件表示">
                <span class="toggle-knob" aria-hidden="true"></span>
              </a>
            {% endif %}
          {% else %}
            <!-- 編集OFF時は“効かない”表示だけ出す（位置固定） -->
            <span class="toggle off is-disabled" aria-disabled="true">
              <span class="toggle-knob" aria-hidden="true"></span>
            </span>
          {% endif %}
        </div>

      </div>
    </form>
  </div>


  {% if edit_mode %}
  <div class="card bulk-card">
    <h2 class="h2">一括操作</h2>

    <form method="post" id="bulkForm">
      {% csrf_token %}
      <input type="hidden" name="selected_ids" id="selectedIds" value="">
      <div class="bulk-grid">
        <div class="bulk-item">
          <div class="muted">カテゴリ一括</div>
          <div class="bulk-row">
            <select name="category_id" class="select">
              <option value="">カテゴリを選択</option>
              {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
            <button class="btn" type="submit" name="bulk_action" value="category">適用</button>
          </div>
        </div>

        <div class="bulk-item">
          <div class="muted">メンバー一括</div>
          <div class="bulk-row">
            <select name="member_id" class="select">
              <option value="">メンバーを選択</option>
              {% for m in members %}
                <option value="{{ m.id }}">{{ m.name }}</option>
              {% endfor %}
            </select>
            <button class="btn" type="submit" name="bulk_action" value="member">適用</button>
          </div>
        </div>

        <div class="bulk-item">
          <div class="muted">確定（カテゴリ&メンバー埋まってる行だけ）</div>
          <button class="btn btn-primary" type="submit" name="bulk_action" value="confirm">確定する</button>
        </div>
      </div>
    </form>
  </div>
  {% endif %}

  <div class="card table-card">
    <div class="table-wrap">
      <table class="table {% if edit_mode %}is-edit{% else %}is-view{% endif %}">
        <thead>
          <tr>
            {% if edit_mode %}<th class="col-check"><input type="checkbox" id="checkAll"></th>{% endif %}
            <th>ID</th>
            <th>日付</th>
            <th>店名</th>
            <th>メモ</th>
            <th>金額</th>
            <th>カテゴリ</th>
            <th>メンバー</th>
            <th>確定</th>
          </tr>
        </thead>

        <tbody id="txTbody">
          {% include "transactions/_transaction_rows.html" %}
        </tbody>

      </table>
    </div>
  </div>
</div>

<script>
(function(){
  const bulkForm = document.getElementById("bulkForm");
  if(!bulkForm) return;

  const selectedIds = document.getElementById("selectedIds");
  const checkAll = document.getElementById("checkAll");

  function getChecks(){
    return Array.from(document.querySelectorAll(".rowCheck"));
  }

  function sync(){
    const ids = getChecks().filter(c => c.checked).map(c => c.value);
    selectedIds.value = ids.join(",");
  }

  function bindChecks(){
    const checks = getChecks();
    checks.forEach(c => c.addEventListener("change", sync));

    if(checkAll){
      checkAll.checked = false;
      checkAll.addEventListener("change", () => {
        checks.forEach(c => c.checked = checkAll.checked);
        sync();
      });
    }
  }

  bulkForm.addEventListener("submit", (e) => {
    sync();
    if(!selectedIds.value){
      e.preventDefault();
      alert("チェックされた行がないよ");
    }
  });

  // ★ 初回
  bindChecks();

  // ★ 検索で rows が差し替わった後に呼ばせる用
  window.rebindBulkChecks = bindChecks;
})();
</script>


<script>
  (function(){
    const form = document.querySelector("form.table-toolbar");
    const input = form?.querySelector('input[name="q"]');
    const tbody = document.getElementById("txTbody");
    if(!form || !input || !tbody) return;

    function buildRowsUrl(nextQ){
      const url = new URL(window.location.href);
      url.pathname = url.pathname.replace(/\/?$/, "/") + "rows/"; // /transactions/rows/
      if(nextQ) url.searchParams.set("q", nextQ);
      else url.searchParams.delete("q");
      return url.toString();
    }

    function updateAddressBar(nextQ){
      const url = new URL(window.location.href);
      if(nextQ) url.searchParams.set("q", nextQ);
      else url.searchParams.delete("q");
      history.replaceState(null, "", url.toString());
    }

    let t = null;
    let lastToken = 0;

    async function fetchRows(q){
      const token = ++lastToken;
      const res = await fetch(buildRowsUrl(q), { headers: { "X-Requested-With": "fetch" }});
      if(!res.ok) return;
      const html = await res.text();
      if(token !== lastToken) return; // 古いレスポンスは捨てる
      tbody.innerHTML = html;

      tbody.innerHTML = html;
      updateAddressBar(q);

      // ★ これを追加
      if (window.rebindBulkChecks) {
        window.rebindBulkChecks();
      }

      updateAddressBar(q);
      // フォーカス維持（遷移しないので基本要らないけど保険）
      input.focus({ preventScroll: true });
      const v = input.value || "";
      input.setSelectionRange(v.length, v.length);
    }

    input.addEventListener("input", () => {
      window.clearTimeout(t);
      t = window.setTimeout(() => {
        fetchRows(input.value.trim());
      }, 250); // ちょい短めでOK
    });

    input.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        window.clearTimeout(t);
        fetchRows(input.value.trim());
      }
    });
  })();
</script>

<script>
(function(){
  const details = document.querySelector(".summary-shell details.acc");
  if(!details) return;

  const summary = details.querySelector("summary");
  const content = details.querySelector(".summary-content");
  if(!summary || !content) return;

  const curPath = window.location.pathname;          // /transactions/
  const ref = document.referrer || "";               // 直前URL
  let shouldOpen = false;

  if(ref){
    try{
      const refUrl = new URL(ref);
      // 同一オリジン かつ 直前が /transactions/ 以外なら「別ページから来た」とみなす
      if(refUrl.origin === window.location.origin && !refUrl.pathname.startsWith(curPath)){
        shouldOpen = true;
      }
    }catch(e){
      // referrer が変な形式なら無視（閉じのまま）
    }
  }

  if(shouldOpen){
    details.open = true;
    content.style.height = "auto";
    content.style.opacity = "1";
  }else{
    // 編集ON/OFFなど（同ページ内遷移）のときは常に閉じ
    details.open = false;
    content.style.height = "0px";
    content.style.opacity = "0";
  }

  summary.addEventListener("click", (e) => {
    e.preventDefault();

    const isOpen = details.open;

    if(!isOpen){
      // OPEN
      details.open = true;                 // 先に open にする（中身を計測できるように）
      content.style.height = "0px";        // 0 から
      content.offsetHeight;                // reflow
      const h = content.scrollHeight;
      content.style.height = h + "px";
      content.style.opacity = "1";

      // 終わったら auto に戻す（中身が増減しても崩れない）
      const onEnd = (ev) => {
        if(ev.propertyName !== "height") return;
        content.style.height = "auto";
        content.removeEventListener("transitionend", onEnd);
      };
      content.addEventListener("transitionend", onEnd);

    } else {
      // CLOSE
      const h = content.scrollHeight;      // auto だと取れないことがあるので一旦 px 固定
      content.style.height = h + "px";
      content.offsetHeight;                // reflow
      content.style.height = "0px";
      content.style.opacity = "0";

      const onEnd = (ev) => {
        if(ev.propertyName !== "height") return;
        details.open = false;              // アニメ後に閉じる（ここが肝）
        content.removeEventListener("transitionend", onEnd);
      };
      content.addEventListener("transitionend", onEnd);
    }
  });
})();
</script>

<!-- Tableページ、編集モード／全件表示等のトグル -->
<script>
(function(){
  const toggles = document.querySelectorAll("a.toggle.js-toggle-anim");
  if(!toggles.length) return;

  toggles.forEach(toggle => {
    toggle.addEventListener("click", (e) => {
      if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0) return;

      e.preventDefault();
      const href = toggle.getAttribute("href");

      // 見た目反転（ノブをぬるっ）
      if (toggle.classList.contains("on")) {
        toggle.classList.remove("on");
        toggle.classList.add("off");
      } else {
        toggle.classList.remove("off");
        toggle.classList.add("on");
      }

      window.setTimeout(() => {
        window.location.href = href;
      }, 160);
    });
  });
})();
</script>


{% endblock %}
