{% extends "account/base.html" %}
{% load static %}

{% block title %}明細一覧{% endblock %}

{% block content %}
  <header class="page-header">
    <div>
      <h1 class="page-title">明細登録・編集</h1>
      <p class="page-subtitle">CSV取込 → 明細確認 → 編集/確定</p>
    </div>
    <a class="btn btn-ghost" href="{% url 'home' %}">← Homeへ戻る</a>
  </header>

  <!-- CSV取込 -->
<div class="card">
  <div class="card-title">CSV取り込み</div>

    <form method="post" enctype="multipart/form-data" class="stack">
      {% csrf_token %}
      <div class="row">
        <input class="input" type="file" name="csv_file" accept=".csv" />
        <button class="btn" type="submit">CSVを取り込む</button>
      </div>

      {% if message %}
        <p class="notice">{{ message }}</p>
      {% endif %}
    </form>
  </div>

  <!-- サマリ -->
  <div class="card">
    <div class="card-title">最新データ（確定済みのみ）サマリ</div>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>区分</th>
            <th>合計</th>
            <th>一人当たり</th>
            <th>住信SBI振込</th>
          </tr>
        </thead>
        <tbody>
          {% for row in summary_rows %}
            <tr>
              <td>{{ row.label }}</td>
              <td>{{ row.total }}</td>
              <td>{{ row.per_person }}</td>
              <td>{{ row.sbi }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="muted">サマリデータがありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if summary_note %}
      <p class="muted" style="margin-top:10px;">{{ summary_note }}</p>
    {% endif %}
  </div>

  <!-- 検索・表示状態 -->
  <div class="card">
    <div class="card-title">明細の検索</div>

    <form method="get" class="stack">
      <div class="row">
        <input
          class="input"
          type="text"
          name="q"
          placeholder="カテゴリ / メモ / 店名 / 金額"
          value="{{ request.GET.q }}"
        />
        <button class="btn" type="submit">検索</button>
      </div>

      <div class="row row-tight">
        <span class="muted">
          編集モード：
          {% if edit_mode %}<b>ON</b>{% else %}OFF{% endif %}
        </span>

        {% if current_filename %}
          <span class="muted">対象ファイル：<b>{{ current_filename }}</b></span>
        {% endif %}

        <!-- ここは既存のトグルURLがあるなら差し替えてOK -->
        {% if toggle_edit_url %}
          <a class="btn btn-ghost" href="{{ toggle_edit_url }}">編集モード切替</a>
        {% endif %}
      </div>
    </form>
  </div>

  <!-- 明細一覧 -->
  <div class="card">
    <div class="card-title">明細一覧</div>

    <div class="table-wrap">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>日付</th>
            <th>店名・サービス名</th>
            <th>金額</th>
            <th>メンバー</th>
            <th>カテゴリ</th>
            <th>メモ</th>
            <th>ファイル名</th>
            <th>確定済み</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
            <tr>
              <td>{{ t.id }}</td>
              <td>{{ t.date }}</td>
              <td>{{ t.store_name }}</td>
              <td>{{ t.amount }}</td>
              <td>{{ t.member }}</td>
              <td>{{ t.category }}</td>
              <td>{{ t.memo }}</td>
              <td>{{ t.file_name }}</td>
              <td>{{ t.is_confirmed }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="9" class="muted">明細がありません。</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}
