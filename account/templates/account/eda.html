{% extends "account/base.html" %}
{% load humanize %}
{% block title %}EDA{% endblock %}

{% block content %}
<h1>EDA</h1>

<div class="card">
  <h2 class="h2">データ健全性の確認</h2>
  <p class="muted">
    請求月（CSVファイル単位）ごとの件数・合計金額・未確定率を確認します。
  </p>

  <table class="summary-table">
    <thead>
      <tr>
        <th>請求月</th>
        <th class="num">件数</th>
        <th class="num">合計金額</th>
        <th class="num">未確定</th>
        <th class="num">未確定率</th>
      </tr>
    </thead>
    <tbody>
      {% for r in billing_stats %}
      <tr>
        <td>{{ r.billing_month }}</td>
        <td class="num">{{ r.count|intcomma }}</td>
        <td class="num">¥{{ r.total|intcomma }}</td>
        <td class="num">{{ r.unclosed|intcomma }}</td>
        <td class="num">{{ r.unclosed_rate }}%</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5" class="muted">データがありません</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="muted" style="margin-top:10px;">
    判定メモ：件数が極端に落ちる請求月／合計が桁飛びする請求月／未確定率が高止まりする請求月がないかを見る。
  </div>
</div>

<!-- 請求月 × メンバー -->
<div class="card">
  <h2 class="h2">粒度・傾向の把握：メンバー別（請求月）</h2>
  <p class="muted">請求月（CSV単位）ごとのメンバー別合計。</p>

  <table class="summary-table">
    <thead>
      <tr>
        <th>請求月</th>
        {% for c in member_cols %}
          <th class="num">{{ c }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in member_table %}
      <tr>
        <td>{{ r.billing_month }}</td>
        {% for cell in r.cells %}
          <td class="num">¥{{ cell.total|intcomma }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- 追加：請求月 × カテゴリ（上位） -->
<div class="card">
  <h2 class="h2">粒度・傾向の把握：カテゴリ上位（請求月）</h2>
  <p class="muted">全期間で金額が大きいカテゴリ上位のみを表示。</p>

  <table class="summary-table">
    <thead>
      <tr>
        <th>請求月</th>
        {% for c in cat_cols %}
          <th class="num">{{ c }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in category_table %}
      <tr>
        <td>{{ r.billing_month }}</td>
        {% for cell in r.cells %}
          <td class="num">¥{{ cell.total|intcomma }}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="muted" style="margin-top:10px;">
    ※カテゴリが多いと見づらいので、上位のみ（{{ cat_cols|length }}件）に絞ってる。
  </div>
</div>

<div class="card">
  <h2 class="h2">分析に進む価値の判断</h2>
  <p class="muted">（次）このデータで予測する価値があるか、前提が満たせるか</p>
</div>
{% endblock %}
