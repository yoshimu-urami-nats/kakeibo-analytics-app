{% extends "account/base.html" %}
{% load humanize %}
{% block title %}Prediction{% endblock %}

{% block content %}
<h1>Prediction</h1>

<div class="card">
  <h2 class="h2">前提条件</h2>
  <ul class="muted">
    <li>予測単位：請求月（CSV単位）</li>
    <li>予測対象：請求月ごとの合計支出（カテゴリ除外後）</li>
    <li>除外カテゴリ（暫定）：{{ exclude_keywords|join:", " }}</li>
  </ul>
</div>

<div class="card">
  <h2 class="h2">入力データ（請求月 × 合計支出）</h2>

  <table class="summary-table">
    <thead>
      <tr>
        <th>請求月</th>
        <th class="num">合計（除外後）</th>
      </tr>
    </thead>
    <tbody>
      {% for r in series %}
      <tr>
        <td>{{ r.billing_month }}</td>
        <td class="num">¥{{ r.total|intcomma }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="2" class="muted">データがありません</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2 class="h2">予測結果（線形回帰）</h2>

  {% if pred_next %}
    <p>
      来月（{{ next_month }}）の予測：<b>¥{{ pred_next|intcomma }}</b>
    </p>
    <p class="muted">
      傾向（目安）：1請求月あたり <b>{{ slope|floatformat:0 }}</b> 円くらい増減
    </p>
  {% else %}
    <p class="muted">データが2か月分以上ないので、まだ回帰できません。</p>
  {% endif %}
</div>

<div class="card">
  <h2 class="h2">バックテスト（過去データで精度チェック）</h2>

  {% if metrics.n and metrics.n > 0 %}
    <p class="muted">
      検証方法：過去{{ min_train }}か月以上たまった時点から、毎月「その時点までのデータ」で翌月（当月）を予測し、実績と比較。
    </p>

    <ul class="muted">
      <li>検証回数：<b>{{ metrics.n }}</b></li>
      <li>MAE（平均絶対誤差）：<b>¥{{ metrics.mae|intcomma }}</b></li>
      <li>RMSE（誤差の大きい月に厳しい）：<b>¥{{ metrics.rmse|intcomma }}</b></li>
      {% if metrics.mape %}
        <li>MAPE（平均%誤差）：<b>{{ metrics.mape }}%</b></li>
      {% endif %}
    </ul>

    <table class="summary-table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>対象月</th>
          <th class="num">学習月数</th>
          <th class="num">予測</th>
          <th class="num">実績</th>
          <th class="num">誤差(予測-実績)</th>
          <th class="num">絶対誤差</th>
          <th class="num">%誤差</th>
        </tr>
      </thead>
      <tbody>
        {% for r in backtests %}
        <tr>
          <td>{{ r.month }}</td>
          <td class="num">{{ r.train_months }}</td>
          <td class="num">¥{{ r.pred|intcomma }}</td>
          <td class="num">¥{{ r.actual|intcomma }}</td>
          <td class="num">{% if r.error >= 0 %}+{% endif %}¥{{ r.error|intcomma }}</td>
          <td class="num">¥{{ r.abs_error|intcomma }}</td>
          <td class="num">
            {% if r.ape != None %}
              {{ r.ape|floatformat:1 }}%
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p class="muted" style="margin-top:10px;">
      ※精度が悪い月がある場合、「一時的イベント支出（旅行/家具/家電/医療/税金等）」が原因かを疑い、
      その月の扱い（除外/別カテゴリ化/特徴量追加）を検討。
    </p>

  {% else %}
    <p class="muted">
      バックテストするにはデータが足りません（最低 {{ min_train|add:"1" }} か月分必要）。
    </p>
  {% endif %}
</div>

<div class="card">
  <h2 class="h2">解釈と限界</h2>
  <p class="muted">
    これは「家具・家電のような突発支出」を除外したうえで、
    過去の推移を一本の直線で近似した“目安”です。
    一時的なイベント支出が起きた月は誤差が出ます。
  </p>
</div>
{% endblock %}
