<!-- account\templates\account\prediction.html -->

{% extends "account/base.html" %}
{% load humanize %}
{% load guest_filters %}
{% block title %}Prediction{% endblock %}

{% block content %}
<h1>Prediction</h1>

<div class="card">
  <h2 class="h2">前提条件</h2>
  <ul class="muted">
    <li>予測単位：請求月（CSV単位）</li>
    <li>予測対象：請求月ごとの合計支出（カテゴリ除外後）</li>
    <li>除外カテゴリ（暫定）：{{ exclude_keywords|join:", " }}</li>
  </ul>

  <h2 class="h2" style="margin-top:14px;">設定</h2>

  <p class="muted">
    ・除外カテゴリ：予測から除外したい支出カテゴリをカンマ区切りで指定できます。<br>
    ・学習開始月数：最低何ヶ月分のデータを使ってから予測を開始するかを指定します。
  </p>

  <form method="get" class="table-toolbar" style="grid-template-columns: 1fr 180px auto; gap:10px;">
    <input class="input" type="text" name="exclude" placeholder="除外カテゴリ（カンマ区切り）"
           value="{{ exclude_param|default:'' }}">

    <input class="input" type="number" name="min_train" min="2"
           value="{{ min_train }}" style="text-align:right;">

    <button class="btn" type="submit">再計算</button>
  </form>

  <p class="muted" style="margin-top:8px;">
    例：exclude=家具,家電 / min_train=6
  </p>

</div>


{# ===== Phase1：今月の判定（最新月カード） ===== #}
<div class="card">
  <h2 class="h2">今月の判定</h2>
  {% if latest_judgement and latest_judgement.month %}
    <p class="muted" style="margin-top:6px;">
      対象月：<b>{{ latest_judgement.month }}</b>
    </p>

    <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;">
      <div><span class="muted">タグ：</span><b>{{ latest_judgement.tag }}</b></div>
      <div>
        <span class="muted">合計：</span>
        {% if latest_judgement.total != None %}¥{{ latest_judgement.total|intcomma }}{% else %}—{% endif %}
      </div>
      <div>
        <span class="muted">Z：</span>
        {% if latest_judgement.z != None %}{{ latest_judgement.z }}{% else %}—{% endif %}
      </div>
      <div>
        <span class="muted">APE：</span>
        {% if latest_judgement.ape != None %}{{ latest_judgement.ape|floatformat:1 }}%{% else %}—{% endif %}
      </div>
    </div>

    {% if latest_judgement.note %}
      <p class="muted" style="margin-top:10px;">※{{ latest_judgement.note }}</p>
    {% endif %}
  {% else %}
    <p class="muted">データがありません。</p>
  {% endif %}
</div>

{# ===== 追加：交際 含む/除外 の精度比較 ===== #}
<div class="card">
  <h2 class="h2">精度比較：交際を含む / 除外</h2>

  {% if enable_compare %}
    <p class="muted">
      同じ条件で、「交際」だけを除外した場合の精度を比較しています。
    </p>

    <p class="muted" style="margin-top:6px;">
      <a class="compare-toggle" href="?exclude={{ exclude_param|urlencode }}&min_train={{ min_train }}">
        比較をOFF（高速表示）
      </a>
    </p>

  <table class="summary-table" style="margin-top:10px;">
    <thead>
      <tr>
        <th></th>
        <th class="num">検証回数</th>
        <th class="num">MAE</th>
        <th class="num">RMSE</th>
        <th class="num">MAPE</th>
        <th class="num">ベースラインMAE</th>
        <th class="num">改善率(MAE)</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>交際を含む（現状）</td>
        <td class="num">{{ compare_include.metrics.n }}</td>
        <td class="num">{% if compare_include.metrics.mae %}¥{{ compare_include.metrics.mae|intcomma }}{% else %}—{% endif %}</td>
        <td class="num">{% if compare_include.metrics.rmse %}¥{{ compare_include.metrics.rmse|intcomma }}{% else %}—{% endif %}</td>
        <td class="num">{% if compare_include.metrics.mape != None %}{{ compare_include.metrics.mape }}%{% else %}—{% endif %}</td>
        <td class="num">{% if compare_include.metrics.naive_mae %}¥{{ compare_include.metrics.naive_mae|intcomma }}{% else %}—{% endif %}</td>
        <td class="num">{% if compare_include.metrics.mae_improve_pct != None %}{{ compare_include.metrics.mae_improve_pct }}%{% else %}—{% endif %}</td>
      </tr>

      <tr>
        <td>交際を除外（exclude に交際追加）</td>
        <td class="num">{{ compare_exclude.metrics.n }}</td>
        <td class="num">{% if compare_exclude.metrics.mae %}¥{{ compare_exclude.metrics.mae|intcomma }}{% else %}—{% endif %}</td>
        <td class="num">{% if compare_exclude.metrics.rmse %}¥{{ compare_exclude.metrics.rmse|intcomma }}{% else %}—{% endif %}</td>
        <td class="num">{% if compare_exclude.metrics.mape != None %}{{ compare_exclude.metrics.mape }}%{% else %}—{% endif %}</td>
        <td class="num">{% if compare_exclude.metrics.naive_mae %}¥{{ compare_exclude.metrics.naive_mae|intcomma }}{% else %}—{% endif %}</td>
        <td class="num">{% if compare_exclude.metrics.mae_improve_pct != None %}{{ compare_exclude.metrics.mae_improve_pct }}%{% else %}—{% endif %}</td>
      </tr>
    </tbody>
  </table>

  <div class="muted" style="margin-top:10px;">
    現在の除外（交際を含む側）：<b>{{ compare_include.exclude_keywords|join:", " }}</b><br>
    交際を除外した側：<b>{{ compare_exclude.exclude_keywords|join:", " }}</b>
  </div>

  {% else %}
    <p class="muted">
      ※比較（交際を除外した場合の精度）は追加計算が入るため、必要なときだけ表示できます。
    </p>
    <p class="muted" style="margin-top:6px;">
      <a class="compare-toggle" href="?exclude={{ exclude_param|urlencode }}&min_train={{ min_train }}&compare=1">
        比較をON（計算して表示）
      </a>
    </p>
  {% endif %}

</div>

<div class="card">
  <h2 class="h2">入力データ（請求月 × 合計支出）</h2>

  <table class="summary-table">
    <thead>
      <tr>
        <th>請求月</th>
        <th class="num">合計（除外後）</th>
      </tr>
    </thead>
    <tbody>
      {% for r in series %}
      <tr>
        <td>{{ r.billing_month }}</td>
        <td class="num">¥{{ r.total|intcomma }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="2" class="muted">データがありません</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2 class="h2">予測結果（線形回帰）</h2>

  {% if pred_next %}
    <p>
      来月（{{ next_month }}）の予測：<b>¥{{ pred_next|intcomma }}</b>
    </p>
    <p class="muted">
      傾向（目安）：1請求月あたり <b>{{ slope|floatformat:0 }}</b> 円くらい増減
    </p>
  {% else %}
    <p class="muted">データが2か月分以上ないので、まだ回帰できません。</p>
  {% endif %}
</div>

<div class="card">
  <h2 class="h2">バックテスト（過去データで精度チェック）</h2>

  {% if metrics.n and metrics.n > 0 %}
    <p class="muted">
      検証方法：過去{{ min_train }}か月以上たまった時点から、毎月「その時点までのデータ」で翌月（当月）を予測し、実績と比較。
    </p>

    <ul class="muted">
      <li>検証回数：<b>{{ metrics.n }}</b></li>

      <li>
        MAE（平均絶対誤差）：
        <b>¥{{ metrics.mae|intcomma }}</b>
        <span class="muted">（ベースライン：¥{{ metrics.naive_mae|intcomma }}）</span>
        {% if metrics.mae_improve_pct != None %}
          <span class="muted">／改善：<b>{{ metrics.mae_improve_pct }}%</b></span>
        {% endif %}
      </li>

      <li>
        RMSE：
        <b>¥{{ metrics.rmse|intcomma }}</b>
        <span class="muted">（ベースライン：¥{{ metrics.naive_rmse|intcomma }}）</span>
      </li>

      {% if metrics.mape %}
        <li>
          MAPE：
          <b>{{ metrics.mape }}%</b>
          <span class="muted">（ベースライン：{{ metrics.naive_mape }}%）</span>
        </li>
      {% endif %}
    </ul>


    <table class="summary-table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>対象月</th>
          <th class="num">学習月数</th>
          <th class="num">予測</th>
          <th class="num">ベースライン</th>
          <th class="num">実績</th>
          <th class="num">誤差(予測-実績)</th>
          <th class="num">絶対誤差</th>
          <th class="num">%誤差</th>
        </tr>
      </thead>
      <tbody>
        {% for r in backtests %}
        <tr>
          <td>{{ r.month }}</td>
          <td class="num">{{ r.train_months }}</td>
          <td class="num">¥{{ r.pred|intcomma }}</td>
          <td class="num">¥{{ r.naive_pred|intcomma }}</td>
          <td class="num">¥{{ r.actual|intcomma }}</td>
          <td class="num">{% if r.error >= 0 %}+{% endif %}¥{{ r.error|intcomma }}</td>
          <td class="num">¥{{ r.abs_error|intcomma }}</td>
          <td class="num">
            {% if r.ape != None %}
              {{ r.ape|floatformat:1 }}%
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if anomaly_top_months and anomaly_top_months|length > 0 %}
    <div class="card" style="margin-top:12px;">
      <h2 class="h2">統計的に異常な月（Zスコア TOP3）</h2>
      <p class="muted">
        過去の月次合計の「平均との差」を、ばらつき（標準偏差）で割った指標です。<br>
        |Z| が大きいほど “いつもと違う月” です（予測誤差とは別物）。
      </p>

      <table class="summary-table" id="zAnomalyTable">
        <thead>
          <tr>
            <th>対象月</th>
            <th class="num">合計</th>
            <th class="num">Z</th>
          </tr>
        </thead>
        <tbody>
          {% for r in anomaly_top_months %}
          <tr data-month="{{ r.month }}" style="cursor:pointer;">
            <td>{{ r.month }}</td>
            <td class="num">¥{{ r.total|intcomma }}</td>
            <td class="num">{% if r.z >= 0 %}+{% endif %}{{ r.z }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="muted" style="margin-top:8px;">
        ※クリックすると同じ内訳（breakdown）を表示します。
      </div>
    </div>
    {% endif %}

    {% if cross_top and cross_top|length > 0 %}
    <div class="card" style="margin-top:12px;">
      <h2 class="h2">クロス分類（Z × 予測誤差）</h2>
      <p class="muted">
        Zは「支出の異常度」、%誤差は「予測の外れ具合」です。<br>
        両方を見ると「イベント」か「モデル課題」か切り分けやすくなります。
      </p>

      <table class="summary-table" id="crossTable">
        <thead>
          <tr>
            <th>対象月</th>
            <th class="num">合計</th>
            <th class="num">Z</th>
            <th class="num">%誤差</th>
            <th>分類</th>
          </tr>
        </thead>
        <tbody>
          {% for r in cross_top %}
          <tr data-month="{{ r.month }}" style="cursor:pointer;">
            <td>{{ r.month }}</td>
            <td class="num">¥{{ r.total|intcomma }}</td>
            <td class="num">{% if r.z >= 0 %}+{% endif %}{{ r.z }}</td>
            
            <td class="num">
              {% if r.ape != None %}
                {{ r.ape|floatformat:1 }}%
              {% else %}
                —
              {% endif %}
            </td>

            <td>{{ r.label }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="muted" style="margin-top:8px;">
        ※クリックすると同じ内訳（breakdown）を表示します。
      </div>
    </div>
    {% endif %}

    {% if worst_months and worst_months|length > 0 %}
    <div class="card" style="margin-top:12px;">
      <h2 class="h2">誤差が大きい月（要因調査候補）</h2>
      <p class="muted">ズレが大きい月は「一時イベント支出」が混ざっている可能性が高い。</p>

      <table class="summary-table" id="worstMonthsTable">
        <thead>
          <tr>
            <th>対象月</th>
            <th class="num">実績</th>
            <th class="num">予測</th>
            <th class="num">%誤差</th>
          </tr>
        </thead>
        <tbody>
          {% for r in worst_months %}
          <tr data-month="{{ r.month }}" style="cursor:pointer;">
            <td>{{ r.month }}</td>
            <td class="num">¥{{ r.actual|intcomma }}</td>
            <td class="num">¥{{ r.pred|intcomma }}</td>
            <td class="num">{{ r.ape|floatformat:1 }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>
    {% endif %}

    <p class="muted" style="margin-top:10px;">
      ※精度が悪い月がある場合、「一時的イベント支出（交際/家具・家電/医療等）」が原因かを疑い、
      その月の扱い（除外/別カテゴリ化/特徴量追加）を検討。
    </p>

    <div id="breakdownMount"></div>

  {% else %}
    <p class="muted">
      バックテストするにはデータが足りません（最低 {{ min_train|add:"1" }} か月分必要）。
    </p>
  {% endif %}


</div>

<div class="card">
  <h2 class="h2">解釈と限界</h2>
  <p class="muted">
    これは「家具・家電のような突発支出」を除外したうえで、
    過去の推移を一本の直線で近似した“目安”です。
    一時的なイベント支出が起きた月は誤差が出ます。
  </p>

</div>



<script>
(function(){
  // 「誤差が大きい月」テーブルをクリックできるようにする
  const table = document.getElementById("worstMonthsTable");
  const zTable = document.getElementById("zAnomalyTable");
  const mount = document.getElementById("breakdownMount");
  if(!mount) return; // mountだけ必須

  // 現在の exclude/min_train を URL から引き継ぐ（Prediction と同条件で内訳を出す）
  const curUrl = new URL(window.location.href);
  const exclude = curUrl.searchParams.get("exclude") || "";
  const minTrain = curUrl.searchParams.get("min_train") || "";

  const crossTable = document.getElementById("crossTable");

  function buildBreakdownUrl(yyyymm){
    const u = new URL(`/prediction/breakdown/${yyyymm}/`, window.location.origin);
    if(exclude) u.searchParams.set("exclude", exclude);
    if(minTrain) u.searchParams.set("min_train", minTrain); // 使わないけど一応残し
    return u.toString();
  }

  async function loadBreakdown(yyyymm){
    mount.innerHTML = `<div class="card" style="margin-top:12px;"><p class="muted">内訳読み込み中…（${yyyymm}）</p></div>`;
    try{
      const res = await fetch(buildBreakdownUrl(yyyymm), {
        headers: { "X-Requested-With": "fetch" }
      });
      if(!res.ok) throw new Error("fetch failed");
      const html = await res.text();
      mount.innerHTML = html;

      // ちょいスクロール（気持ちよさ）
      mount.scrollIntoView({ behavior: "smooth", block: "start" });
    }catch(e){
      mount.innerHTML = `<div class="card" style="margin-top:12px;"><p class="muted">内訳の取得に失敗した…</p></div>`;
    }
  }

  // worstMonthsTable があるときだけ登録
  if(table){
    table.addEventListener("click", (e) => {
      const tr = e.target.closest("tr[data-month]");
      if(!tr) return;
      const yyyymm = tr.getAttribute("data-month");
      if(!yyyymm) return;
      loadBreakdown(yyyymm);
    });
  }

  // zTable があるときだけ登録
  if(zTable){
    zTable.addEventListener("click", (e) => {
      const tr = e.target.closest("tr[data-month]");
      if(!tr) return;
      const yyyymm = tr.getAttribute("data-month");
      if(!yyyymm) return;
      loadBreakdown(yyyymm);
    });
  }

  // crossTable があるときだけ登録
  if(crossTable){
    crossTable.addEventListener("click", (e) => {
      const tr = e.target.closest("tr[data-month]");
      if(!tr) return;
      const yyyymm = tr.getAttribute("data-month");
      if(!yyyymm) return;
      loadBreakdown(yyyymm);
    });
  }

})();
</script>

{% endblock %}
