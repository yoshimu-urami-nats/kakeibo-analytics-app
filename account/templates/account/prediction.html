{% extends "account/base.html" %}
{% load humanize %}
{% block title %}Prediction{% endblock %}

{% block content %}
<h1>Prediction</h1>

<div class="card">
  <h2 class="h2">前提条件</h2>
  <ul class="muted">
    <li>予測単位：請求月（CSV単位）</li>
    <li>予測対象：請求月ごとの合計支出（カテゴリ除外後）</li>
    <li>除外カテゴリ（暫定）：{{ exclude_keywords|join:", " }}</li>
  </ul>

  <h2 class="h2" style="margin-top:14px;">設定</h2>
  <form method="get" class="table-toolbar" style="grid-template-columns: 1fr 180px auto; gap:10px;">
    <input class="input" type="text" name="exclude" placeholder="除外カテゴリ（カンマ区切り）"
           value="{{ exclude_param|default:'' }}">

    <input class="input" type="number" name="min_train" min="2"
           value="{{ min_train }}" style="text-align:right;">

    <button class="btn" type="submit">再計算</button>
  </form>

  <p class="muted" style="margin-top:8px;">
    例：exclude=家具,家電 / min_train=6
  </p>

</div>

<div class="card">
  <h2 class="h2">入力データ（請求月 × 合計支出）</h2>

  <table class="summary-table">
    <thead>
      <tr>
        <th>請求月</th>
        <th class="num">合計（除外後）</th>
      </tr>
    </thead>
    <tbody>
      {% for r in series %}
      <tr>
        <td>{{ r.billing_month }}</td>
        <td class="num">¥{{ r.total|intcomma }}</td>
      </tr>
      {% empty %}
      <tr><td colspan="2" class="muted">データがありません</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="card">
  <h2 class="h2">予測結果（線形回帰）</h2>

  {% if pred_next %}
    <p>
      来月（{{ next_month }}）の予測：<b>¥{{ pred_next|intcomma }}</b>
    </p>
    <p class="muted">
      傾向（目安）：1請求月あたり <b>{{ slope|floatformat:0 }}</b> 円くらい増減
    </p>
  {% else %}
    <p class="muted">データが2か月分以上ないので、まだ回帰できません。</p>
  {% endif %}
</div>

<div class="card">
  <h2 class="h2">バックテスト（過去データで精度チェック）</h2>

  {% if metrics.n and metrics.n > 0 %}
    <p class="muted">
      検証方法：過去{{ min_train }}か月以上たまった時点から、毎月「その時点までのデータ」で翌月（当月）を予測し、実績と比較。
    </p>

    <ul class="muted">
      <li>検証回数：<b>{{ metrics.n }}</b></li>

      <li>
        MAE（平均絶対誤差）：
        <b>¥{{ metrics.mae|intcomma }}</b>
        <span class="muted">（ベースライン：¥{{ metrics.naive_mae|intcomma }}）</span>
        {% if metrics.mae_improve_pct != None %}
          <span class="muted">／改善：<b>{{ metrics.mae_improve_pct }}%</b></span>
        {% endif %}
      </li>

      <li>
        RMSE：
        <b>¥{{ metrics.rmse|intcomma }}</b>
        <span class="muted">（ベースライン：¥{{ metrics.naive_rmse|intcomma }}）</span>
      </li>

      {% if metrics.mape %}
        <li>
          MAPE：
          <b>{{ metrics.mape }}%</b>
          <span class="muted">（ベースライン：{{ metrics.naive_mape }}%）</span>
        </li>
      {% endif %}
    </ul>


    <table class="summary-table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>対象月</th>
          <th class="num">学習月数</th>
          <th class="num">予測</th>
          <th class="num">ベースライン</th>
          <th class="num">実績</th>
          <th class="num">誤差(予測-実績)</th>
          <th class="num">絶対誤差</th>
          <th class="num">%誤差</th>
        </tr>
      </thead>
      <tbody>
        {% for r in backtests %}
        <tr>
          <td>{{ r.month }}</td>
          <td class="num">{{ r.train_months }}</td>
          <td class="num">¥{{ r.pred|intcomma }}</td>
          <td class="num">¥{{ r.naive_pred|intcomma }}</td>
          <td class="num">¥{{ r.actual|intcomma }}</td>
          <td class="num">{% if r.error >= 0 %}+{% endif %}¥{{ r.error|intcomma }}</td>
          <td class="num">¥{{ r.abs_error|intcomma }}</td>
          <td class="num">
            {% if r.ape != None %}
              {{ r.ape|floatformat:1 }}%
            {% else %}
              —
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if worst_months and worst_months|length > 0 %}
    <div class="card" style="margin-top:12px;">
      <h2 class="h2">誤差が大きい月（要因調査候補）</h2>
      <p class="muted">ズレが大きい月は「一時イベント支出」が混ざっている可能性が高い。</p>

      <table class="summary-table">
        <thead>
          <tr>
            <th>対象月</th>
            <th class="num">実績</th>
            <th class="num">予測</th>
            <th class="num">%誤差</th>
          </tr>
        </thead>
        <tbody>
          {% for r in worst_months %}
          <tr>
            <td>{{ r.month }}</td>
            <td class="num">¥{{ r.actual|intcomma }}</td>
            <td class="num">¥{{ r.pred|intcomma }}</td>
            <td class="num">{{ r.ape|floatformat:1 }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <p class="muted" style="margin-top:10px;">
      ※精度が悪い月がある場合、「一時的イベント支出（交際/家具・家電/医療等）」が原因かを疑い、
      その月の扱い（除外/別カテゴリ化/特徴量追加）を検討。
    </p>

  {% else %}
    <p class="muted">
      バックテストするにはデータが足りません（最低 {{ min_train|add:"1" }} か月分必要）。
    </p>
  {% endif %}


</div>

<div class="card">
  <h2 class="h2">解釈と限界</h2>
  <p class="muted">
    これは「家具・家電のような突発支出」を除外したうえで、
    過去の推移を一本の直線で近似した“目安”です。
    一時的なイベント支出が起きた月は誤差が出ます。
  </p>
</div>
{% endblock %}
